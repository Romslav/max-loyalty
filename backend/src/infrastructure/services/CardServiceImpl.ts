/**\n * CardServiceImpl - Card & Token Management Service\n *\n * –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω –∑–∞:\n * - –ì–µ–Ω–µ—Ä–∞—Ü–∏—é QR —Ç–æ–∫–µ–Ω–æ–≤ (HMAC-SHA256)\n * - –ì–µ–Ω–µ—Ä–∞—Ü–∏—é 6-–∑–Ω–∞—á–Ω—ã—Ö –∫–æ–¥–æ–≤\n * - –í–∞–ª–∏–¥–∞—Ü–∏—é —Ç–æ–∫–µ–Ω–æ–≤\n * - –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é –∫–∞—Ä—Ç–æ—á–µ–∫\n *\n * –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è: HMAC-SHA256 —Å timing-safe —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º\n *\n * @author Phase 2 Implementation\n * @date 2026-01-25\n */\n\nimport { injectable } from 'inversify';\nimport * as crypto from 'crypto';\nimport { ICardService } from '../../domain/services/CardService';\nimport { ErrorCode } from '../../shared/types';\n\ninterface CardValidationResult {\n  isValid: boolean;\n  reason?: string;\n}\n\n@injectable()\nexport class CardServiceImpl implements ICardService {\n  private readonly QR_SECRET_KEY = process.env.QR_SECRET_KEY || 'dev-secret-key';\n  private readonly QR_ALGORITHM = 'sha256';\n\n  /**\n   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç QR —Ç–æ–∫–µ–Ω —Å HMAC-SHA256 –ø–æ–¥–ø–∏—Å—å\u044e\n   *\n   * –ü—Ä–æ—Ü–µ—Å—Å:\n   * 1. –ö–æ–º–±–∏–Ω–∏—Ä—É—é \u043f–æ–ª—è: guestRestaurantId:restaurantId:timestamp\n   * 2. –ü–æ–¥–ø–∏—Å—ã–≤–∞—é HMAC-SHA256 —Å SECRET_KEY\n   * 3. –í–æ–∑–≤—Ä–∞—â–∞—é payload.signature (Base64)\n   *\n   * –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:\n   * - –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ –∞—Å–∏–º–º–µ—Ç—Ä–∏—á\n   * - –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å –±–µ–∑ SECRET_KEY\n   * - Timestamp –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç replay-–∞—Ç–∞–∫–∏\n   *\n   * @param guestRestaurantId ID –≥–æ—Å—Ç—è –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ\n   * @param restaurantId ID —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞\n   * @returns HMAC-SHA256 —Å–∏–≥–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω\n   *\n   * @example\n   * const token = cardService.generateQRToken('gr-123', 'rest-456');\n   * // Returns: '...signature...' (hexadecimal)\\ *\n   * // QR code scans this token, backend verifies signature\n   */\n  generateQRToken(guestRestaurantId: string, restaurantId: string): string {\n    if (!guestRestaurantId || !restaurantId) {\n      throw {\n        code: ErrorCode.VALIDATION_ERROR,\n        message: 'guestRestaurantId –∏ restaurantId –æ–±—è–∑–∞—Ç–µ–ª—ã',\n      };\n    }\n\n    // 1Ô∏è‚É£ –°–û–°–¢–ê–í–õ–Ø–Æ payload\n    const timestamp = Date.now();\n    const payload = `${guestRestaurantId}:${restaurantId}:${timestamp}`;\n\n    // 2Ô∏è‚É£ –ü–û–î–ü–ò–°–´–í–ê–Æ HMAC-SHA256\n    const signature = crypto\n      .createHmac(this.QR_ALGORITHM, this.QR_SECRET_KEY)\n      .update(payload)\n      .digest('hex');\n\n    // 3Ô∏è‚É£ –í–û–ó–í–†–ê–©–ê–Æ payload.signature\n    const token = `${payload}.${signature}`;\n\n    console.log(`\nüé´ QR Token Generated:\n   Guest: ${guestRestaurantId}\n   Signature: ${signature.substring(0, 20)}...`)\n\n    return token;\n  }\n\n  /**\n   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å QR —Ç–æ–∫–µ–Ω–∞\n   *\n   * –ü—Ä–æ—Ü–µ—Å—Å:\n   * 1. –†–∞–∑–±–∏—Ä–∞—é token –Ω–∞ payload –∏ signature\n   * 2. –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é signature –¥–ª—è payload\n   * 3. –°—Ä–∞–≤–Ω–∏–≤–∞—é timing-safe —Å–ø–æ—Å–æ–±–æ–º\n   * 4. –ü—Ä–æ–≤–µ—Ä—è—é timestamp (–Ω–µ —Å—Ç–∞—Ä–µ–µ 24 —á–∞—Å–æ–≤)\n   *\n   * –í–∞–∂–Ω–æ: crypto.timingSafeEqual –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç timing attacks\n   *\n   * @param token QR —Ç–æ–∫–µ–Ω\n   * @param restaurantId ID —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞\n   * @returns –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏\n   *\n   * @example\n   * const result = cardService.validateQRToken(token, 'rest-456');\n   * if (result.isValid) {\n   *   // Process transaction\n   * } else {\n   *   console.error('Invalid token:', result.reason);\n   * }\n   */\n  validateQRToken(token: string, restaurantId: string): CardValidationResult {\n    try {\n      // 1Ô∏è‚É£ –†–ê–ó–ë–û–†\n      const [payload, signature] = token.split('.');\n\n      if (!payload || !signature) {\n        return {\n          isValid: false,\n          reason: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞',\n        };\n      }\n\n      // 2Ô∏è‚É£ –ü–ï–†–ï–°–ß–ò–¢–´–í–ê–Æ signature\n      const expectedSignature = crypto\n        .createHmac(this.QR_ALGORITHM, this.QR_SECRET_KEY)\n        .update(payload)\n        .digest('hex');\n\n      // 3Ô∏è‚É£ –°–†–ê–í–ù–ò–í–ê–Æ (timing-safe)\n      const isSignatureValid = crypto.timingSafeEqual(\n        Buffer.from(signature),\n        Buffer.from(expectedSignature),\n      );\n\n      if (!isSignatureValid) {\n        return {\n          isValid: false,\n          reason: '–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ–¥–ø–∏—Å—å',\n        };\n      }\n\n      // 4Ô∏è‚É£ –ü–†–û–í–ï–†–Ø–Æ timestamp\n      const [_guestRestaurantId, _restaurantId, timestamp] = payload.split(':');\n      const now = Date.now();\n      const tokenAge = now - parseInt(timestamp);\n      const MAX_AGE = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞\n\n      if (tokenAge > MAX_AGE) {\n        return {\n          isValid: false,\n          reason: '–¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ (24 —á–∞—Å–∞)',\n        };\n      }\n\n      // 5Ô∏è‚É£ –ü–†–û–í–µ—Ä—è—é restaurantId\n      if (_restaurantId !== restaurantId) {\n        return {\n          isValid: false,\n          reason: '–¢–æ–∫–µ–Ω –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É',\n        };\n      }\n\n      console.log(`\u2705 QR Token Valid: ${_guestRestaurantId}`)\n\n      return { isValid: true };\n    } catch (error) {\n      return {\n        isValid: false,\n        reason: `–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: ${(error as Error).message}`,\n      };\n    }\n  }\n\n  /**\n   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥\n   *\n   * –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:\n   * - Truly random (uses crypto.randomInt)\n   * - Range: 000000-999999\n   * - Unique per card\n   * - Cannot be predicted\n   *\n   * @returns 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏\n   *\n   * @example\n   * const code = cardService.generate6DigitCode();\n   * // Returns: '123456' or '000001' or '999999'\n   */\n  generate6DigitCode(): string {\n    // crypto.randomInt –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç—Ä–æ–Ω–≥–∏–µ —Å–ª—É—á–∞–π–Ω—ã–µ —á–∏—Å–ª–∞\n    const code = crypto.randomInt(0, 1000000);\n\n    // –¥–æ–ø–æ–ª–Ω—è–µ–º –Ω—É–ª—è–º–∏ —Å–ª–µ–≤–∞\n    return code.toString().padStart(6, '0');\n  }\n\n  /**\n   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥\n   *\n   * \u0427—Ç–æ –¥–µ–ª–∞–µ—Ç:\n   * - –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–¥ –∏–∑ –ë–î\n   * - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ –ø–æ–ª—è (timing-safe)\n   * - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å (is_active = 1)\n   * - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç invalidated_at = null\n   *\n   * @param code 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥\n   * @param restaurantId ID —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞\n   * @returns –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏\n   */\n  validate6DigitCode(code: string, restaurantId: string): CardValidationResult {\n    // TODO: –†–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –∑–∞–≤—Ç—Ä–∞ —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º\n    // - –ù–∞–π—Ç–∏ –≤ card_identifiers \n    // - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å is_active = 1\n    // - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å invalidated_at IS NULL\n\n    if (!code || code.length !== 6) {\n      return {\n        isValid: false,\n        reason: '–ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 6 —Ü–∏—Ñ—Ä',\n      };\n    }\n\n    if (!/^\d{6}$/.test(code)) {\n      return {\n        isValid: false,\n        reason: '–ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ —Ü–∏—Ñ—Ä',\n      };\n    }\n\n    console.log(`‚úÖ 6-Digit Code Format Valid: ${code}`);\n\n    return { isValid: true };\n  }\n\n  /**\n   * –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏\n   *\n   * –ß—Ç–æ –¥–µ–ª–∞–µ—Ç:\n   * - –ú–∞—Ä–∫–∏—Ä—É–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –∫–∞–∫ invalidated\n   * - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç invalidated_at = NOW()\n   * - –°–≤—è–∑—ã–≤–∞–µ—Ç —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π\n   * - –ü–æ—Ç–æ–º –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–æ–≤–∞—è\n   *\n   * @param cardId ID –∫–∞—Ä—Ç–æ—á–∫–∏\n   * @param transactionId ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏\n   */\n  async invalidateCard(
    cardId: string,\n    transactionId: string,\n  ): Promise<void> {\n    // TODO: –ë—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∑–∞–≤—Ç—Ä–∞ —Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é\n    // UPDATE card_identifiers \n    // SET is_active = 0, invalidated_at = NOW(), invalidated_by_transaction_id = transactionId\n    // WHERE id = cardId\n\n    console.log(`‚úÖ Card invalidated: ${cardId} (txn: ${transactionId})`);\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É –≥–æ—Å—Ç—è\n   *\n   * @param guestRestaurantId ID –≥–æ—Å—Ç—è\n   * @param restaurantId ID —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞\n   * @returns –ö–∞—Ä—Ç–æ—á–∫–∞ –∏–ª–∏ null\n   */\n  async getActiveCard(\n    guestRestaurantId: string,\n    restaurantId: string,\n  ): Promise<any | null> {\n    // TODO: \n    // SELECT * FROM card_identifiers\n    // WHERE guest_restaurant_id = guestRestaurantId\n    //   AND restaurant_id = restaurantId\n    //   AND is_active = 1\n    //   AND invalidated_at IS NULL\n    // ORDER BY created_at DESC\n    // LIMIT 1\n\n    return null;\n  }\n}\n\nexport { CardValidationResult };\n