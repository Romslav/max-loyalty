import { useEffect, useCallback } from 'react';\nimport { useAuthStore } from '@stores/authStore';\nimport { useNotificationStore } from '@stores/notificationStore';\nimport { websocketService } from '@services/websocketService';\n\ninterface UseNotificationsOptions {\n  autoConnect?: boolean;\n  debug?: boolean;\n}\n\n/**\n * Hook for managing WebSocket connections and real-time notifications\n * Place in App.tsx or root layout component\n */\nexport function useNotifications(options: UseNotificationsOptions = {}) {\n  const { autoConnect = true, debug = false } = options;\n  const { user, token } = useAuthStore();\n  const notificationStore = useNotificationStore();\n\n  // Connect to WebSocket when user is authenticated\n  useEffect(() => {\n    if (!autoConnect || !user || !token) {\n      return;\n    }\n\n    const setupWebSocket = async () => {\n      try {\n        if (debug) console.log('[useNotifications] Connecting WebSocket...');\n        await websocketService.connect(token);\n        console.log('[useNotifications] WebSocket connected');\n\n        // Subscribe to user's specific channels based on role\n        switch (user.role) {\n          case 'admin':\n            websocketService.subscribe('system_events', {});\n            break;\n\n          case 'restaurant':\n            websocketService.subscribe('points_operations', {\n              restaurantId: user.restaurantId,\n            });\n            break;\n\n          case 'guest':\n            websocketService.subscribe('guest_card', {\n              guestId: user.id,\n            });\n            break;\n\n          case 'cashier':\n            websocketService.subscribe('points_operations', {\n              restaurantId: user.restaurantId,\n            });\n            break;\n        }\n\n        if (debug) console.log('[useNotifications] Subscriptions set up');\n      } catch (error) {\n        console.error('[useNotifications] Connection failed:', error);\n        notificationStore.showNotification({\n          type: 'error',\n          title: 'Connection Failed',\n          message: 'Could not connect to real-time server. Features may be limited.',\n          duration: 5000,\n        });\n      }\n    };\n\n    setupWebSocket();\n\n    // Cleanup on unmount or user change\n    return () => {\n      if (debug) console.log('[useNotifications] Cleaning up WebSocket');\n      websocketService.disconnect();\n    };\n  }, [user, token, autoConnect, debug]);\n\n  // Setup event listeners\n  useEffect(() => {\n    // Points added event\n    const unsubscribePointsAdded = websocketService.on(\n      'points_added',\n      (data) => {\n        if (debug) console.log('[Event] Points added:', data);\n\n        notificationStore.addNotification({\n          id: data.transactionId,\n          type: 'points_added',\n          title: 'Points Added! ðŸŽ‰',\n          message: `+${data.amount} points at ${data.restaurantName}`,\n          data,\n          read: false,\n          timestamp: data.timestamp,\n          priority: 'medium',\n        });\n\n        notificationStore.showNotification({\n          type: 'success',\n          title: 'Points Added',\n          message: `+${data.amount} points`,\n          duration: 3000,\n        });\n\n        notificationStore.incrementPointsAdded(data.amount);\n      }\n    );\n\n    // Points redeemed event\n    const unsubscribePointsRedeemed = websocketService.on(\n      'points_redeemed',\n      (data) => {\n        if (debug) console.log('[Event] Points redeemed:', data);\n\n        notificationStore.addNotification({\n          id: data.transactionId,\n          type: 'points_redeemed',\n          title: 'Points Redeemed! âœ¨',\n          message: `${data.rewardName} redeemed`,\n          data,\n          read: false,\n          timestamp: data.timestamp,\n          priority: 'high',\n        });\n\n        notificationStore.showNotification({\n          type: 'success',\n          title: 'Reward Redeemed',\n          message: data.rewardName,\n          duration: 3000,\n        });\n\n        notificationStore.incrementPointsRedeemed(data.amount);\n      }\n    );\n\n    // Card created event\n    const unsubscribeCardCreated = websocketService.on(\n      'card_created',\n      (data) => {\n        if (debug) console.log('[Event] Card created:', data);\n\n        notificationStore.addNotification({\n          id: data.cardId,\n          type: 'card_created',\n          title: 'New Loyalty Card ðŸ’³',\n          message: `Card created at ${data.restaurantName}`,\n          data,\n          read: false,\n          timestamp: data.timestamp,\n          priority: 'medium',\n        });\n\n        notificationStore.showNotification({\n          type: 'success',\n          title: 'Loyalty Card Created',\n          message: data.restaurantName,\n          duration: 4000,\n        });\n\n        notificationStore.incrementCardsCreated();\n      }\n    );\n\n    // Guest registered event\n    const unsubscribeGuestRegistered = websocketService.on(\n      'guest_registered',\n      (data) => {\n        if (debug) console.log('[Event] Guest registered:', data);\n\n        notificationStore.addNotification({\n          id: data.guestId,\n          type: 'guest_registered',\n          title: 'New Guest Registered ðŸ‘¤',\n          message: `${data.guestName} joined your restaurant`,\n          data,\n          read: false,\n          timestamp: data.timestamp,\n          priority: 'low',\n        });\n      }\n    );\n\n    // Admin alert event\n    const unsubscribeAdminAlert = websocketService.on(\n      'admin_notification',\n      (data) => {\n        if (debug) console.log('[Event] Admin notification:', data);\n\n        notificationStore.addNotification({\n          id: data.notificationId,\n          type: 'admin_alert',\n          title: data.title,\n          message: data.message,\n          data,\n          read: false,\n          timestamp: data.timestamp,\n          priority: data.priority || 'medium',\n        });\n\n        notificationStore.showNotification({\n          type: 'info',\n          title: data.title,\n          message: data.message,\n          duration: 5000,\n        });\n      }\n    );\n\n    // Points expired event\n    const unsubscribePointsExpired = websocketService.on(\n      'points_expired',\n      (data) => {\n        if (debug) console.log('[Event] Points expired:', data);\n\n        notificationStore.addNotification({\n          id: `expired-${Date.now()}`,\n          type: 'points_redeemed',\n          title: 'Points Expired â°',\n          message: `${data.amount} points expired due to inactivity`,\n          data,\n          read: false,\n          timestamp: data.timestamp,\n          priority: 'high',\n        });\n\n        notificationStore.showNotification({\n          type: 'warning',\n          title: 'Points Expired',\n          message: `${data.amount} points will be removed`,\n          duration: 5000,\n        });\n      }\n    );\n\n    // System error event\n    const unsubscribeError = websocketService.on('error', (data) => {\n      console.error('[Event] WebSocket error:', data);\n\n      notificationStore.showNotification({\n        type: 'error',\n        title: 'Error',\n        message: data.message,\n        duration: 5000,\n      });\n    });\n\n    // Cleanup\n    return () => {\n      unsubscribePointsAdded?.();\n      unsubscribePointsRedeemed?.();\n      unsubscribeCardCreated?.();\n      unsubscribeGuestRegistered?.();\n      unsubscribeAdminAlert?.();\n      unsubscribePointsExpired?.();\n      unsubscribeError?.();\n    };\n  }, [debug]);\n\n  // Return useful methods and status\n  const subscribe = useCallback(\n    (\n      type: 'guest_card' | 'points_operations' | 'system_events' | 'restaurant_transactions',\n      data: Record<string, any>\n    ) => {\n      websocketService.subscribe(type, data);\n    },\n    []\n  );\n\n  const unsubscribe = useCallback(\n    (\n      type: 'guest_card' | 'points_operations' | 'system_events' | 'restaurant_transactions',\n      data: Record<string, any>\n    ) => {\n      websocketService.unsubscribe(type, data);\n    },\n    []\n  );\n\n  const emit = useCallback((event: string, data?: any) => {\n    websocketService.emit(event, data);\n  }, []);\n\n  return {\n    isConnected: websocketService.isActive(),\n    subscribe,\n    unsubscribe,\n    emit,\n    socketId: websocketService.getSocketId(),\n  };\n}\n