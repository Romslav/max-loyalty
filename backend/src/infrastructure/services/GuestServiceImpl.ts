/**\n * GuestServiceImpl - Guest Management Service Implementation\n *\n * –†–µ–∞–ª–∏–∑—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –≥–æ—Å—Ç—è–º–∏:\n * - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è\n * - –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞\n * - –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n * - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞\n * - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è\n *\n * @author Phase 2 Implementation\n * @date 2026-01-25\n */\n\nimport { injectable, inject } from 'inversify';\nimport { IGuestService } from '../../domain/services/GuestService';\nimport { IGuestRepository, IPhoneVerificationRepository } from '../../domain/repositories';\nimport { TYPES } from '../../shared/types';\nimport { GuestEntity } from '../../domain/entities';\nimport { ErrorCode } from '../../shared/types';\n\ninterface RegisterGuestInput {\n  phone: string;\n  name: string;\n  email?: string;\n}\n\ninterface VerifyPhoneInput {\n  phone: string;\n  verificationCode: string;\n}\n\ninterface BlockGuestInput {\n  guestId: string;\n  reason: string;\n}\n\ninterface UpdateGuestInfoInput {\n  guestId: string;\n  name?: string;\n  email?: string;\n}\n\n@injectable()\nexport class GuestServiceImpl implements IGuestService {\n  constructor(\n    @inject(TYPES.Repositories.IGuestRepository)\n    private guestRepository: IGuestRepository,\n\n    @inject(TYPES.Repositories.IPhoneVerificationRepository)\n    private phoneVerificationRepository: IPhoneVerificationRepository,\n  ) {}\n\n  /**\n   * –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤–æ–≥–æ –≥–æ—Å—Ç—è\n   *\n   * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç:\n   * - Phone –∏ name –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã\n   * - Phone –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω\n   * - Email —Ñ–æ—Ä–º–∞—Ç (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)\n   *\n   * @param input –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏\n   * @returns –°–æ–∑–¥–∞–Ω–Ω—ã–π –≥–æ—Å—Ç—å —Å ID\n   * @throws ErrorCode.VALIDATION_ERROR –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã\n   * @throws ErrorCode.GUEST_ALREADY_EXISTS –µ—Å–ª–∏ –≥–æ—Å—Ç—å —Å —Ç–∞–∫–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º —É–∂–µ –µ—Å—Ç—å\n   *\n   * @example\n   * const guest = await guestService.registerGuest({\n   *   phone: '+79991234567',\n   *   name: '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤',\n   *   email: 'ivan@example.com'\n   * });\n   * // Returns: { id: 'g-123', phone, name, isVerified: false, ... }\n   */\n  async registerGuest(input: RegisterGuestInput): Promise<GuestEntity> {\n    // 1Ô∏è‚É£ –í–ê–õ–ò–î–ê–¶–ò–Ø –í–•–û–î–ù–´–• –î–ê–ù–ù–´–•\n    if (!input.phone || !input.name) {\n      throw {\n        code: ErrorCode.VALIDATION_ERROR,\n        message: 'Phone –∏ name –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏',\n      };\n    }\n\n    // –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)\n    if (!/^\\+?[0-9]{10,15}$/.test(input.phone.replace(/[^0-9+]/g, ''))) {\n      throw {\n        code: ErrorCode.VALIDATION_ERROR,\n        message: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞',\n      };\n    }\n\n    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω\n    const normalizedPhone = input.phone.replace(/[^0-9+]/g, '');\n\n    // 2Ô∏è‚É£ –ü–†–û–í–ï–†–ö–ê –î–£–ë–õ–ò–†–û–í–ê–ù–ò–Ø\n    const existing = await this.guestRepository.getByPhone(normalizedPhone);\n    if (existing) {\n      throw {\n        code: ErrorCode.GUEST_ALREADY_EXISTS,\n        message: `–ì–æ—Å—Ç—å —Å –Ω–æ–º–µ—Ä–æ–º ${input.phone} —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω`,\n      };\n    }\n\n    // 3Ô∏è‚É£ –°–û–ó–î–ê–ù–ò–ï –°–£–©–ù–û–°–¢–ò\n    const guest = GuestEntity.create({\n      id: this.generateGuestId(),\n      phone: normalizedPhone,\n      name: input.name.trim(),\n      email: input.email?.trim(),\n      isVerified: false,\n      isBlocked: false,\n      blockReason: undefined,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    });\n\n    // 4Ô∏è‚É£ –°–û–•–†–ê–ù–ï–ù–ò–ï\n    await this.guestRepository.create(guest);\n\n    console.log(`‚úÖ Guest registered: ${guest.id} (${input.phone})`);\n\n    return guest;\n  }\n\n  /**\n   * –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≥–æ—Å—Ç—è\n   *\n   * –õ–æ–≥–∏–∫–∞:\n   * - –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é SMS –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é\n   * - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥\n   * - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (10 –º–∏–Ω—É—Ç)\n   * - –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ\n   *\n   * @param input Phone –∏ verification code\n   * @returns –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥–æ—Å—Ç—å\n   * @throws ErrorCode.GUEST_NOT_FOUND –µ—Å–ª–∏ –≥–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω\n   * @throws ErrorCode.VERIFICATION_FAILED –µ—Å–ª–∏ –∫–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π\n   * @throws ErrorCode.VERIFICATION_EXPIRED –µ—Å–ª–∏ –∫–æ–¥ –∏—Å—Ç–µ–∫\n   *\n   * @example\n   * const guest = await guestService.verifyPhone({\n   *   phone: '+79991234567',\n   *   verificationCode: '123456'\n   * });\n   * // Returns: { ...guest, isVerified: true }\n   */\n  async verifyPhone(input: VerifyPhoneInput): Promise<GuestEntity> {\n    // 1Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –ì–û–°–¢–Ø\n    const normalizedPhone = input.phone.replace(/[^0-9+]/g, '');\n    const guest = await this.guestRepository.getByPhone(normalizedPhone);\n\n    if (!guest) {\n      throw {\n        code: ErrorCode.GUEST_NOT_FOUND,\n        message: `–ì–æ—Å—Ç—å —Å –Ω–æ–º–µ—Ä–æ–º ${input.phone} –Ω–µ –Ω–∞–π–¥–µ–Ω`,\n      };\n    }\n\n    // 2Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –ü–û–°–õ–ï–î–ù–Æ–Æ –í–ï–†–ò–§–ò–ö–ê–¶–ò–Æ\n    const verification = await this.phoneVerificationRepository\n      .getLatestForPhone(normalizedPhone);\n\n    if (!verification) {\n      throw {\n        code: ErrorCode.VERIFICATION_FAILED,\n        message: 'SMS –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ –±—ã–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞',\n      };\n    }\n\n    // 3Ô∏è‚É£ –ü–†–û–í–ï–†–ò–¢–¨ –°–†–û–ö –î–ï–ô–°–¢–í–ò–Ø (10 –º–∏–Ω—É—Ç)\n    const now = new Date();\n    const expiresAt = new Date(verification.expiresAt);\n    if (now > expiresAt) {\n      throw {\n        code: ErrorCode.VERIFICATION_EXPIRED,\n        message: '–ö–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏—Å—Ç–µ–∫ (10 –º–∏–Ω—É—Ç)',\n      };\n    }\n\n    // 4Ô∏è‚É£ –ü–†–û–í–ï–†–ò–¢–¨ –ö–û–î\n    if (verification.verificationCode !== input.verificationCode) {\n      // –£–≤–µ–ª–∏—á–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫\n      verification.attempts++;\n      await this.phoneVerificationRepository.update(verification.id, verification);\n\n      // –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏\n      if (verification.attempts >= 3) {\n        throw {\n          code: ErrorCode.VERIFICATION_FAILED,\n          message: '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ (3)',\n        };\n      }\n\n      throw {\n        code: ErrorCode.VERIFICATION_FAILED,\n        message: `–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ (–æ—Å—Ç–∞–ª–æ—Å—å ${3 - verification.attempts} –ø–æ–ø—ã—Ç–æ–∫)`,\n      };\n    }\n\n    // 5Ô∏è‚É£ –û–¢–ú–ï–¢–ò–¢–¨ –ö–ê–ö –í–ï–†–ò–§–ò–¶–ò–†–û–í–ê–ù–û\n    guest.markAsVerified();\n    await this.guestRepository.update(guest.id, guest);\n\n    // –û—Ç–º–µ—Ç–∏—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é\n    verification.verified = true;\n    verification.verifiedAt = new Date();\n    await this.phoneVerificationRepository.update(verification.id, verification);\n\n    console.log(`‚úÖ Phone verified: ${guest.id} (${input.phone})`);\n\n    return guest;\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ—Å—Ç—è –ø–æ ID\n   *\n   * @param guestId ID –≥–æ—Å—Ç—è\n   * @returns –ì–æ—Å—Ç—å –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω\n   *\n   * @example\n   * const guest = await guestService.getGuest('g-123');\n   */\n  async getGuest(guestId: string): Promise<GuestEntity | null> {\n    if (!guestId) {\n      throw {\n        code: ErrorCode.VALIDATION_ERROR,\n        message: 'guestId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω',\n      };\n    }\n\n    const guest = await this.guestRepository.getById(guestId);\n\n    if (!guest) {\n      throw {\n        code: ErrorCode.GUEST_NOT_FOUND,\n        message: `–ì–æ—Å—Ç—å ${guestId} –Ω–µ –Ω–∞–π–¥–µ–Ω`,\n      };\n    }\n\n    return guest;\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç –≥–æ—Å—Ç—è –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞\n   *\n   * @param phone –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞\n   * @returns –ì–æ—Å—Ç—å –∏–ª–∏ null\n   */\n  async getByPhone(phone: string): Promise<GuestEntity | null> {\n    const normalizedPhone = phone.replace(/[^0-9+]/g, '');\n    return this.guestRepository.getByPhone(normalizedPhone);\n  }\n\n  /**\n   * –ë–ª–æ–∫–∏—Ä—É–µ—Ç –≥–æ—Å—Ç—è —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø—Ä–∏—á–∏–Ω–æ–π\n   *\n   * –°–ª—É—á–∞–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:\n   * - –ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ\n   * - –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª\n   * - –ü–æ –∑–∞–ø—Ä–æ—Å—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n   * - –ó–∞–ø—Ä–æ—Å —Å–∞–º–æ–≥–æ –≥–æ—Å—Ç—è\n   *\n   * @param input Guest ID –∏ reason\n   * @throws ErrorCode.GUEST_NOT_FOUND –µ—Å–ª–∏ –≥–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω\n   * @throws ErrorCode.GUEST_ALREADY_BLOCKED –µ—Å–ª–∏ —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω\n   *\n   * @example\n   * await guestService.blockGuest({\n   *   guestId: 'g-123',\n   *   reason: '–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ –Ω–∞ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ'\n   * });\n   */\n  async blockGuest(input: BlockGuestInput): Promise<void> {\n    const guest = await this.getGuest(input.guestId);\n\n    if (guest.isBlocked) {\n      throw {\n        code: ErrorCode.GUEST_ALREADY_BLOCKED,\n        message: `–ì–æ—Å—Ç—å —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (–ø—Ä–∏—á–∏–Ω–∞: ${guest.blockReason})`,\n      };\n    }\n\n    guest.block(input.reason);\n    await this.guestRepository.update(input.guestId, guest);\n\n    console.log(`‚õî Guest blocked: ${input.guestId} (reason: ${input.reason})`);\n  }\n\n  /**\n   * –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –≥–æ—Å—Ç—è\n   *\n   * @param guestId ID –≥–æ—Å—Ç—è\n   * @throws ErrorCode.GUEST_NOT_FOUND –µ—Å–ª–∏ –≥–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω\n   * @throws ErrorCode.GUEST_NOT_BLOCKED –µ—Å–ª–∏ –≥–æ—Å—Ç—å –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω\n   *\n   * @example\n   * await guestService.unblockGuest('g-123');\n   */\n  async unblockGuest(guestId: string): Promise<void> {\n    const guest = await this.getGuest(guestId);\n\n    if (!guest.isBlocked) {\n      throw {\n        code: ErrorCode.GUEST_NOT_BLOCKED,\n        message: '–ì–æ—Å—Ç—å –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω',\n      };\n    }\n\n    guest.unblock();\n    await this.guestRepository.update(guestId, guest);\n\n    console.log(`‚úÖ Guest unblocked: ${guestId}`);\n  }\n\n  /**\n   * –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–æ—Å—Ç—è\n   *\n   * –ú–æ–∂–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å:\n   * - name\n   * - email\n   *\n   * @param input Guest ID –∏ –ø–æ–ª—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\n   * @throws ErrorCode.GUEST_NOT_FOUND –µ—Å–ª–∏ –≥–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω\n   *\n   * @example\n   * await guestService.updateGuestInfo({\n   *   guestId: 'g-123',\n   *   name: '–ò–≤–∞–Ω –ù–æ–≤–∏–∫–æ–≤',\n   *   email: 'ivan.novikov@example.com'\n   * });\n   */\n  async updateGuestInfo(input: UpdateGuestInfoInput): Promise<void> {\n    const guest = await this.getGuest(input.guestId);\n\n    if (input.name) {\n      guest.updateName(input.name.trim());\n    }\n\n    if (input.email) {\n      guest.updateEmail(input.email.trim());\n    }\n\n    guest.updatedAt = new Date();\n    await this.guestRepository.update(input.guestId, guest);\n\n    console.log(`‚úèÔ∏è Guest updated: ${input.guestId}`);\n  }\n\n  /**\n   * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SMS –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é\n   * (–±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –î–µ–Ω—å 8-9 —Å Twilio)\n   *\n   * @param phone –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞\n   */\n  async sendVerificationSMS(phone: string): Promise<string> {\n    const normalizedPhone = phone.replace(/[^0-9+]/g, '');\n\n    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥\n    const verificationCode = this.generate6DigitCode();\n\n    // TODO: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ Twilio –≤ –î–µ–Ω—å 8-9\n    // const message = `Your verification code: ${verificationCode}`;\n    // await twilioService.sendSMS(normalizedPhone, message);\n\n    // –í—Ä–µ–º–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ\n    console.log(`üì± SMS Code: ${verificationCode} (TEMPORARY - remove in production)`);\n\n    return verificationCode;\n  }\n\n  // ===== PRIVATE HELPERS =====\n\n  /**\n   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –≥–æ—Å—Ç—è\n   * –§–æ—Ä–º–∞—Ç: g-{timestamp}-{random}\n   */\n  private generateGuestId(): string {\n    return `g-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n  }\n\n  /**\n   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥\n   */\n  private generate6DigitCode(): string {\n    return Math.floor(100000 + Math.random() * 900000).toString();\n  }\n}\n\nexport { RegisterGuestInput, VerifyPhoneInput, BlockGuestInput, UpdateGuestInfoInput };\n