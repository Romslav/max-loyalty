import { WebSocketServer } from './websocketServer';\n\n/**\n * Event handlers for WebSocket events\n * These are called from various API endpoints\n */\nexport class EventHandlers {\n  constructor(private wsServer: WebSocketServer) {}\n\n  /**\n   * Handle points added event from transaction API\n   * Call this after creating a new points transaction\n   */\n  onPointsAdded(payload: {\n    transactionId: string;\n    guestId: string;\n    cardId: string;\n    amount: number;\n    newBalance: number;\n    restaurantId: string;\n    restaurantName: string;\n    description: string;\n    timestamp: number;\n  }): void {\n    try {\n      this.wsServer.broadcastPointsAdded(payload);\n    } catch (error) {\n      console.error('[EventHandler] Points added error:', error);\n    }\n  }\n\n  /**\n   * Handle points redeemed event\n   * Call this after redeeming a reward\n   */\n  onPointsRedeemed(payload: {\n    transactionId: string;\n    guestId: string;\n    cardId: string;\n    amount: number;\n    newBalance: number;\n    restaurantId: string;\n    rewardName: string;\n    timestamp: number;\n  }): void {\n    try {\n      this.wsServer.broadcastPointsRedeemed(payload);\n    } catch (error) {\n      console.error('[EventHandler] Points redeemed error:', error);\n    }\n  }\n\n  /**\n   * Handle points expiration\n   * Call this during scheduled expiration job\n   */\n  onPointsExpired(payload: {\n    guestId: string;\n    amount: number;\n    newBalance: number;\n    expiryDate: string;\n    reason: string;\n    timestamp: number;\n  }): void {\n    try {\n      this.wsServer.broadcastPointsExpired(payload);\n    } catch (error) {\n      console.error('[EventHandler] Points expired error:', error);\n    }\n  }\n\n  /**\n   * Handle new loyalty card creation\n   */\n  onCardCreated(payload: {\n    guestId: string;\n    cardId: string;\n    restaurantId: string;\n    restaurantName: string;\n    qrCode: string;\n    initialPoints: number;\n    timestamp: number;\n  }): void {\n    try {\n      this.wsServer.broadcastCardCreated(payload);\n    } catch (error) {\n      console.error('[EventHandler] Card created error:', error);\n    }\n  }\n\n  /**\n   * Handle new guest registration\n   */\n  onGuestRegistered(payload: {\n    guestId: string;\n    guestName: string;\n    email: string;\n    restaurantId: string;\n    timestamp: number;\n  }): void {\n    try {\n      // Notify restaurant\n      const restaurantRoomId = `restaurant:${payload.restaurantId}:points`;\n      this.wsServer.getInstance().to(restaurantRoomId).emit('guest_registered', payload);\n\n      // Notify all admins\n      this.wsServer.broadcastToAdmins('guest_registered', payload);\n\n      console.log('[EventHandler] Guest registered:', payload.guestId);\n    } catch (error) {\n      console.error('[EventHandler] Guest registered error:', error);\n    }\n  }\n\n  /**\n   * Handle guest card status change\n   */\n  onGuestCardStatusChanged(payload: {\n    guestId: string;\n    cardId: string;\n    restaurantId: string;\n    status: 'active' | 'suspended' | 'blocked';\n    reason?: string;\n    timestamp: number;\n  }): void {\n    try {\n      this.wsServer.sendToUser(payload.guestId, 'guest_card_updated', payload);\n      this.wsServer\n        .getInstance()\n        .to(`restaurant:${payload.restaurantId}:points`)\n        .emit('guest_card_status_changed', payload);\n\n      console.log('[EventHandler] Card status changed:', payload.cardId);\n    } catch (error) {\n      console.error('[EventHandler] Card status changed error:', error);\n    }\n  }\n\n  /**\n   * Handle transaction in restaurant\n   * For live transaction feed on restaurant dashboard\n   */\n  onRestaurantTransaction(payload: {\n    restaurantId: string;\n    transactionId: string;\n    guestId: string;\n    guestName: string;\n    type: 'purchase' | 'redemption';\n    amount: number;\n    totalToday?: number;\n    timestamp: number;\n  }): void {\n    try {\n      this.wsServer\n        .getInstance()\n        .to(`restaurant:${payload.restaurantId}:transactions`)\n        .emit('restaurant_transaction', payload);\n\n      console.log('[EventHandler] Restaurant transaction:', payload.transactionId);\n    } catch (error) {\n      console.error('[EventHandler] Restaurant transaction error:', error);\n    }\n  }\n\n  /**\n   * Handle restaurant status change\n   */\n  onRestaurantStatusChanged(payload: {\n    restaurantId: string;\n    status: 'active' | 'inactive' | 'maintenance';\n    reason?: string;\n    estimatedRestore?: number;\n    timestamp: number;\n  }): void {\n    try {\n      this.wsServer\n        .getInstance()\n        .to(`restaurant:${payload.restaurantId}:points`)\n        .emit('restaurant_status_changed', payload);\n\n      this.wsServer.broadcastToAdmins('restaurant_status_changed', payload);\n\n      console.log('[EventHandler] Restaurant status changed:', payload.restaurantId);\n    } catch (error) {\n      console.error('[EventHandler] Restaurant status changed error:', error);\n    }\n  }\n\n  /**\n   * Send system alert to admins\n   */\n  sendSystemAlert(payload: {\n    level: 'info' | 'warning' | 'error' | 'critical';\n    title: string;\n    message: string;\n    source: string;\n    timestamp: number;\n  }): void {\n    try {\n      this.wsServer.broadcastToAdmins('system_alert', payload);\n      console.log('[EventHandler] System alert sent:', payload.title);\n    } catch (error) {\n      console.error('[EventHandler] System alert error:', error);\n    }\n  }\n\n  /**\n   * Send admin notification\n   */\n  sendAdminNotification(payload: {\n    notificationId: string;\n    adminId?: string; // If specific admin\n    type: string;\n    title: string;\n    message: string;\n    priority: 'low' | 'medium' | 'high' | 'critical';\n    actionRequired: boolean;\n    data?: Record<string, any>;\n    timestamp: number;\n  }): void {\n    try {\n      if (payload.adminId) {\n        this.wsServer.sendToUser(payload.adminId, 'admin_notification', payload);\n      } else {\n        this.wsServer.broadcastToAdmins('admin_notification', payload);\n      }\n      console.log('[EventHandler] Admin notification sent:', payload.title);\n    } catch (error) {\n      console.error('[EventHandler] Admin notification error:', error);\n    }\n  }\n}\n