// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTH & USER MODELS
// ============================================================================

model User {
  id                    String          @id @default(cuid())
  email                 String          @unique
  phoneNumber           String?         @unique
  firstName             String?
  lastName              String?
  passwordHash          String
  role                  UserRole        @default(USER)
  status                UserStatus      @default(ACTIVE)
  
  // Telegram integration
  telegramId            String?         @unique
  telegramUsername      String?
  telegramFirstName     String?
  telegramLastName      String?
  
  // Relations
  restaurants           RestaurantStaff[]
  guestCards            GuestCard[]
  transactions          Transaction[]
  preferences           UserPreferences?
  auditLogs             AuditLog[]
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  lastLoginAt           DateTime?
  
  @@index([email])
  @@index([telegramId])
  @@index([createdAt])
}

enum UserRole {
  ADMIN
  OWNER
  STAFF
  USER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

model UserPreferences {
  id                    String          @id @default(cuid())
  userId                String          @unique
  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  notificationsEnabled  Boolean         @default(true)
  emailNotifications    Boolean         @default(true)
  telegramNotifications Boolean         @default(true)
  smsNotifications      Boolean         @default(false)
  
  language              String          @default("en")
  timezone              String          @default("UTC")
  theme                 String          @default("light")
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
}

// ============================================================================
// RESTAURANT MODELS
// ============================================================================

model Restaurant {
  id                    String          @id @default(cuid())
  name                  String
  description           String?
  
  // Contact & Location
  email                 String          @unique
  phoneNumber           String?
  address               String?
  city                  String?
  country               String?
  postalCode            String?
  coordinates           String?         // GeoJSON format
  
  // Business info
  registrationNumber    String?         @unique
  taxId                 String?         @unique
  website               String?
  logo                  String?         // URL
  
  // Loyalty settings
  pointsPerPurchase     Int             @default(10)
  pointsExpirationDays  Int             @default(365)
  
  // QR Code settings
  qrCodeRotationMinutes Int             @default(5)  // Critical security feature
  qrCodeSecret          String          @unique      // For HMAC signing
  qrCodeVersion         Int             @default(1)  // Version tracking
  
  status                RestaurantStatus @default(ACTIVE)
  
  // Relations
  staff                 RestaurantStaff[]
  guestCards            GuestCard[]
  tiers                 LoyaltyTier[]
  points                PointLog[]
  transactions          Transaction[]
  analytics             Analytics[]
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  @@index([email])
  @@index([status])
  @@index([createdAt])
}

enum RestaurantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

model RestaurantStaff {
  id                    String          @id @default(cuid())
  userId                String
  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurantId          String
  restaurant            Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  role                  StaffRole       @default(STAFF)
  status                StaffStatus     @default(ACTIVE)
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  @@unique([userId, restaurantId])
  @@index([restaurantId])
  @@index([role])
}

enum StaffRole {
  OWNER
  MANAGER
  STAFF
}

enum StaffStatus {
  ACTIVE
  INACTIVE
  REMOVED
}

// ============================================================================
// GUEST CARD MODELS (CRITICAL)
// ============================================================================

model GuestCard {
  id                    String          @id @default(cuid())
  restaurantId          String
  restaurant            Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  // Card identification (CRITICAL NEW TABLE)
  identifiers           CardIdentifier[]
  
  // Guest info (can be registered or not)
  userId                String?
  user                  User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  guestName             String?         // If unregistered
  guestPhone            String?         // If unregistered
  guestEmail            String?         // If unregistered
  
  // Card status
  status                CardStatus      @default(ACTIVE)
  cardType              CardType        @default(STANDARD)
  tierId                String?
  tier                  LoyaltyTier?    @relation(fields: [tierId], references: [id], onDelete: SetNull)
  
  // Points & rewards
  currentPoints         Int             @default(0)
  totalPointsEarned     Int             @default(0)
  totalPointsRedeemed   Int             @default(0)
  
  // Tracking
  lastUsedAt            DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  // Relations
  transactions          Transaction[]
  pointLogs             PointLog[]
  
  @@index([restaurantId])
  @@index([userId])
  @@index([status])
  @@index([tierId])
  @@index([createdAt])
}

// CRITICAL: New table for card code tracking
model CardIdentifier {
  id                    String          @id @default(cuid())
  cardId                String
  card                  GuestCard       @relation(fields: [cardId], references: [id], onDelete: Cascade)
  restaurantId          String          // For quick lookup
  
  // Code info
  code                  String          @unique      // QR code value or identifier
  codeType              CodeType        @default(QR_CODE)
  codeVersion           Int             @default(1)  // For rotation
  
  // Security
  hmacSignature         String?         // For verification
  isActive              Boolean         @default(true)
  rotatedAt             DateTime?
  expiresAt             DateTime?       // For temporary codes
  
  // Usage tracking
  usageCount            Int             @default(0)
  lastUsedAt            DateTime?
  
  createdAt             DateTime        @default(now())
  
  @@unique([code, restaurantId])
  @@index([cardId])
  @@index([restaurantId])
  @@index([isActive])
  @@index([createdAt])
}

enum CodeType {
  QR_CODE
  BARCODE
  NFC
  SMS_CODE
}

enum CardStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BLOCKED
}

enum CardType {
  STANDARD
  PREMIUM
  VIP
  FAMILY
}

// ============================================================================
// LOYALTY TIER MODELS
// ============================================================================

model LoyaltyTier {
  id                    String          @id @default(cuid())
  restaurantId          String
  restaurant            Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  name                  String          // Silver, Gold, Platinum, etc.
  description           String?
  level                 Int             @unique
  
  // Requirements
  minPointsRequired     Int             @default(0)
  minPurchaseAmount     Decimal         @default(0)
  
  // Benefits
  pointMultiplier       Decimal         @default(1)
  discountPercentage    Decimal         @default(0)
  bonusPoints           Int             @default(0)
  bonusPointsMonthly    Int             @default(0)
  
  // Status
  isActive              Boolean         @default(true)
  
  // Relations
  cards                 GuestCard[]
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  @@index([restaurantId])
  @@index([level])
}

// ============================================================================
// TRANSACTION & POINTS MODELS
// ============================================================================

model Transaction {
  id                    String          @id @default(cuid())
  restaurantId          String
  restaurant            Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Restrict)
  cardId                String
  card                  GuestCard       @relation(fields: [cardId], references: [id], onDelete: Restrict)
  
  staffId               String?         // Who processed the transaction
  staff                 User?           @relation(fields: [staffId], references: [id], onDelete: SetNull)
  
  // Transaction details
  type                  TransactionType @default(PURCHASE)
  status                TransactionStatus @default(COMPLETED)
  amount                Decimal
  currency              String          @default("USD")
  description           String?
  
  // Points
  pointsEarned          Int             @default(0)
  pointsRedeemed        Int             @default(0)
  pointsAdjustment      Int             @default(0)  // Manual adjustments
  
  // Codes used
  codeId                String?         // The code that was scanned
  codeName              String?
  
  // Metadata
  metadata              String?         // JSON: order number, items, etc.
  referenceId           String?         // External ID (order ID, etc.)
  
  // Timestamps
  transactionDate       DateTime        @default(now())
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  // Relations
  pointLogs             PointLog[]
  
  @@index([restaurantId])
  @@index([cardId])
  @@index([staffId])
  @@index([status])
  @@index([transactionDate])
  @@index([createdAt])
}

enum TransactionType {
  PURCHASE
  REFUND
  ADJUSTMENT
  BONUS
  REDEMPTION
  EXPIRATION
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  DISPUTED
}

model PointLog {
  id                    String          @id @default(cuid())
  restaurantId          String
  restaurant            Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Restrict)
  cardId                String
  card                  GuestCard       @relation(fields: [cardId], references: [id], onDelete: Restrict)
  transactionId         String?
  transaction           Transaction?    @relation(fields: [transactionId], references: [id], onDelete: SetNull)
  
  // Points change
  pointsChange          Int
  balanceBefore         Int
  balanceAfter          Int
  
  // Reason
  reason                PointLogReason
  description           String?
  
  createdAt             DateTime        @default(now())
  
  @@index([restaurantId])
  @@index([cardId])
  @@index([transactionId])
  @@index([createdAt])
}

enum PointLogReason {
  PURCHASE
  PURCHASE_REFUND
  REDEMPTION
  ADMIN_ADJUSTMENT
  TIER_BONUS
  MONTHLY_BONUS
  REFERRAL
  EXPIRATION
  PROMOTION
}

// ============================================================================
// ANALYTICS & AUDIT MODELS
// ============================================================================

model Analytics {
  id                    String          @id @default(cuid())
  restaurantId          String
  restaurant            Restaurant      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  
  // Daily stats
  date                  DateTime        @db.Date
  totalTransactions     Int             @default(0)
  totalRevenue          Decimal         @default(0)
  totalPointsIssued     Int             @default(0)
  totalPointsRedeemed   Int             @default(0)
  uniqueCards           Int             @default(0)
  newCards              Int             @default(0)
  
  // Engagement
  activeCards           Int             @default(0)
  repeatCustomers       Int             @default(0)
  averageOrderValue     Decimal         @default(0)
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  @@unique([restaurantId, date])
  @@index([restaurantId])
  @@index([date])
}

model AuditLog {
  id                    String          @id @default(cuid())
  userId                String
  user                  User            @relation(fields: [userId], references: [id], onDelete: Restrict)
  
  // Action details
  action                String          // Action performed
  entityType            String          // What was modified (User, Card, Transaction, etc.)
  entityId              String          // ID of the entity
  
  // Changes
  changesBefore         String?         // JSON of old values
  changesAfter          String?         // JSON of new values
  
  // Request info
  ipAddress             String?
  userAgent             String?
  statusCode            Int?
  
  createdAt             DateTime        @default(now())
  
  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@index([action])
}

// ============================================================================
// NOTIFICATION MODELS
// ============================================================================

model Notification {
  id                    String          @id @default(cuid())
  
  // Recipient
  userId                String?         // If for user
  restaurantId          String?         // If for restaurant
  telegramChatId        String?         // If for telegram
  
  // Content
  type                  NotificationType
  title                 String
  body                  String
  metadata              String?         // JSON
  
  // Status
  isRead                Boolean         @default(false)
  isDelivered           Boolean         @default(false)
  deliveryChannel       DeliveryChannel @default(IN_APP)
  
  createdAt             DateTime        @default(now())
  readAt                DateTime?
  deliveredAt           DateTime?
  
  @@index([userId])
  @@index([restaurantId])
  @@index([telegramChatId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  TRANSACTION_CONFIRMATION
  POINTS_EARNED
  TIER_UPGRADE
  REWARD_AVAILABLE
  PROMOTION
  SYSTEM_ALERT
  VERIFICATION_CODE
}

enum DeliveryChannel {
  IN_APP
  EMAIL
  SMS
  TELEGRAM
}
