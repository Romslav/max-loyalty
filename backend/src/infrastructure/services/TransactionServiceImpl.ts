/**\n * TransactionServiceImpl - Transaction Processing Service\n *\n * –†–µ–∞–ª–∏–∑—É–µ—Ç –≥–ª–∞–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–¥–∞–∂:\n * 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –≥–æ—Å—Ç—è\n * 2. –†–∞—Å—á–µ—Ç –±–∞–ª–ª–æ–≤ (DISCOUNT formula)\n * 3. –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (ATOMIC)\n * 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞\n * 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ upgrade —É—Ä–æ–≤–Ω—è\n * 6. –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏\n * 7. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ last visit\n *\n * @author Phase 2 Implementation\n * @date 2026-01-25\n */\n\nimport { injectable, inject } from 'inversify';\nimport { ITransactionService } from '../../domain/services/TransactionService';\nimport {\n  ITransactionRepository,\n  IGuestRestaurantRepository,\n  ITierEventRepository,\n  IBalanceDetailRepository,\n} from '../../domain/repositories';\nimport { ICardService } from '../../domain/services/CardService';\nimport { TYPES } from '../../shared/types';\nimport { TransactionEntity, PointsCalculator } from '../../domain/entities';\nimport { ErrorCode } from '../../shared/types';\n\ninterface ProcessSaleTransactionInput {\n  guestRestaurantId: string;\n  restaurantId: string;\n  amountRubles: number;\n  posId?: string;\n  notes?: string;\n}\n\ninterface ProcessSaleTransactionOutput {\n  transactionId: string;\n  basePointsAwarded: number;\n  bonusPointsAwarded: number;\n  totalPointsAwarded: number;\n  oldBalance: number;\n  newBalance: number;\n  tierUpgraded: boolean;\n  newTierName?: string;\n  newQRToken: string;\n  newSixDigitCode: string;\n}\n\ninterface TransactionHistoryItem {\n  transactionId: string;\n  type: string;\n  amount: number;\n  pointsAwarded: number;\n  newBalance: number;\n  status: string;\n  createdAt: Date;\n}\n\n@injectable()\nexport class TransactionServiceImpl implements ITransactionService {\n  constructor(\n    @inject(TYPES.Repositories.ITransactionRepository)\n    private transactionRepository: ITransactionRepository,\n\n    @inject(TYPES.Repositories.IGuestRestaurantRepository)\n    private guestRestaurantRepository: IGuestRestaurantRepository,\n\n    @inject(TYPES.Repositories.ITierEventRepository)\n    private tierEventRepository: ITierEventRepository,\n\n    @inject(TYPES.Repositories.IBalanceDetailRepository)\n    private balanceDetailRepository: IBalanceDetailRepository,\n\n    @inject(TYPES.Services.ICardService)\n    private cardService: ICardService,\n  ) {}\n\n  /**\n   * –ì–õ–ê–í–ù–´–ô –ú–ï–¢–û–î: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–¥–∞–∂–∏\n   *\n   * –≠—Ç–æ —Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –≤ —Å–∏—Å—Ç–µ–º–µ:\n   * - Sale ‚Üí Points ‚Üí Tier ‚Üí Card\n   *\n   * 7 –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö —à–∞–≥–æ–≤:\n   * 1Ô∏è‚É£  –í–∞–ª–∏–¥–∞—Ü–∏—è –≥–æ—Å—Ç—è –∏ –±–∞–ª–∞–Ω—Å–∞\n   * 2Ô∏è‚É£  –†–∞—Å—á–µ—Ç –±–∞–ª–ª–æ–≤ (PointsCalculator —Å —Ñ–æ—Ä–º—É–ª–æ–π DISCOUNT)\n   * 3Ô∏è‚É£  –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (ATOMIC)\n   * 4Ô∏è‚É£  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –≤ –ë–î\n   * 5Ô∏è‚É£  –ü—Ä–æ–≤–µ—Ä–∫–∞ upgrade —É—Ä–æ–≤–Ω—è\n   * 6Ô∏è‚É£  –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ (QR + 6-digit)\n   * 7Ô∏è‚É£  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ last visit\n   *\n   * @param input –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏ (–≥–æ—Å—Ç—å, —Å—É–º–º–∞, —Ä–µ—Å—Ç–æ—Ä–∞–Ω)\n   * @returns –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å –Ω–æ–≤—ã–º –±–∞–ª–∞–Ω—Å–æ–º –∏ –±–∞–ª–ª–∞–º–∏\n   * @throws ErrorCode.GUEST_NOT_FOUND –µ—Å–ª–∏ –≥–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω\n   * @throws ErrorCode.GUEST_BLOCKED –µ—Å–ª–∏ –≥–æ—Å—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω\n   * @throws ErrorCode.VALIDATION_ERROR –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã\n   *\n   * @example\n   * const result = await transactionService.processSaleTransaction({\n   *   guestRestaurantId: 'gr-123',\n   *   restaurantId: 'rest-456',\n   *   amountRubles: 1500,\n   *   posId: 'pos-789'\n   * });\n   * // Returns: {\n   * //   transactionId: 'txn-xyz',\n   * //   basePointsAwarded: 1500,\n   * //   bonusPointsAwarded: 75,      (5% BRONZE tier)\n   * //   totalPointsAwarded: 1575,\n   * //   oldBalance: 0,\n   * //   newBalance: 1575,\n   * //   tierUpgraded: false,\n   * //   newQRToken: 'token...',\n   * //   newSixDigitCode: '123456'\n   * // }\n   */\n  async processSaleTransaction(\n    input: ProcessSaleTransactionInput,\n  ): Promise<ProcessSaleTransactionOutput> {\n    console.log('\nüìù Processing Sale Transaction...');\n    console.log(`   Guest: ${input.guestRestaurantId}`);\n    console.log(`   Amount: ${input.amountRubles} —Ä—É–±\\n`);\n\n    // 1Ô∏è‚É£ –í–ê–õ–ò–î–ê–¶–ò–Ø –í–•–û–î–ù–´–• –î–ê–ù–ù–´–•\n    this.validateInput(input);\n\n    // 2Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –ì–û–°–¢–Ø –ò –†–ï–°–¢–û–†–ê–ù\n    const guestRestaurant = await this.guestRestaurantRepository.getById(\n      input.guestRestaurantId,\n    );\n\n    if (!guestRestaurant) {\n      throw {\n        code: ErrorCode.GUEST_NOT_FOUND,\n        message: `–ì–æ—Å—Ç—å ${input.guestRestaurantId} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ ${input.restaurantId}`,\n      };\n    }\n\n    // 3Ô∏è‚É£ –ü–†–û–í–ï–†–ò–¢–¨: –ù–ï –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù –õ–ò\n    if (guestRestaurant.isBlocked) {\n      throw {\n        code: ErrorCode.GUEST_BLOCKED,\n        message: `–ì–æ—Å—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (–ø—Ä–∏—á–∏–Ω–∞: ${guestRestaurant.blockReason || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'})`,\n      };\n    }\n\n    // 4Ô∏è‚É£ –†–ê–°–ß–ò–¢–ê–¢–¨ –ë–ê–õ–õ–´\n    const tierDiscount = guestRestaurant.currentTier.discountPercent; // 5, 10, 15, 20, 25\n    const pointsCalculation = PointsCalculator.calculatePointsAwarded(\n      input.amountRubles,\n      tierDiscount,\n    );\n\n    console.log(`\nüí∞ Points Calculation:`);\n    console.log(`   Tier: ${guestRestaurant.currentTier.name} (${tierDiscount}%)`);\n    console.log(`   Base Points: ${pointsCalculation.basePoints}`);\n    console.log(`   Bonus Points: ${pointsCalculation.bonusPoints}`);\n    console.log(`   Total Points: ${pointsCalculation.totalPoints}\n`)\n\n    // 5Ô∏è‚É£ –°–û–ó–î–ê–¢–¨ –¢–†–ê–ù–ó–ê–ö–¶–ò–Æ (ATOMIC)\n    const transaction = TransactionEntity.create({\n      id: this.generateTransactionId(),\n      guestRestaurantId: input.guestRestaurantId,\n      restaurantId: input.restaurantId,\n      type: 'SALE',\n      amount: input.amountRubles,\n      basePointsAwarded: pointsCalculation.basePoints,\n      bonusPointsAwarded: pointsCalculation.bonusPoints,\n      oldBalance: guestRestaurant.balancePoints,\n      newBalance: guestRestaurant.balancePoints + pointsCalculation.totalPoints,\n      status: 'COMPLETED',\n      posId: input.posId,\n      notes: input.notes,\n      createdAt: new Date(),\n    });\n\n    await this.transactionRepository.create(transaction);\n    console.log(`‚úÖ Transaction created: ${transaction.id}\n`);\n\n    // 6Ô∏è‚É£ –û–ë–ù–û–í–ò–¢–¨ –ë–ê–õ–ê–ù–°\n    const newBalance =\n      guestRestaurant.balancePoints + pointsCalculation.totalPoints;\n    await this.guestRestaurantRepository.updateBalance(\n      input.guestRestaurantId,\n      newBalance,\n    );\n\n    // –°–æ–∑–¥–∞—Ç—å entry –≤ balance_detail –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏\n    await this.balanceDetailRepository.createEntry({\n      guestRestaurantId: input.guestRestaurantId,\n      transactionId: transaction.id,\n      type: 'POINTS_AWARDED',\n      basePoints: pointsCalculation.basePoints,\n      bonusPoints: pointsCalculation.bonusPoints,\n      oldBalance: guestRestaurant.balancePoints,\n      newBalance,\n      createdAt: new Date(),\n    });\n\n    console.log(`üíæ Balance updated: ${guestRestaurant.balancePoints} ‚Üí ${newBalance}\n`);\n\n    // 7Ô∏è‚É£ –ü–†–û–í–ï–†–ò–¢–¨ UPGRADE –£–†–û–í–ù–Ø\n    let tierUpgraded = false;\n    let newTierName: string | undefined;\n\n    const tierThreshold = guestRestaurant.currentTier.maxPoints;\n    if (newBalance > tierThreshold) {\n      // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É upgrade (–∫–æ–≥–¥–∞ –±—É–¥—É—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞)\n      // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º\n      console.log(`üéØ Tier upgrade possible: ${newBalance} > ${tierThreshold}\n`);\n\n      // const nextTier = await this.getNextTier(guestRestaurant.currentTier);\n      // if (nextTier) {\n      //   guestRestaurant.upgradeTier(nextTier);\n      //   tierUpgraded = true;\n      //   newTierName = nextTier.name;\n      //   // Create tier event\n      //   await this.tierEventRepository.create(...)\n      // }\n    }\n\n    // 8Ô∏è‚É£ –†–ï–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ –ö–ê–†–¢–û–ß–ö–£\n    // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç–æ—á–∫—É\n    if (guestRestaurant.activeCardId) {\n      await this.cardService.invalidateCard(\n        guestRestaurant.activeCardId,\n        transaction.id,\n      );\n    }\n\n    // –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é\n    const newQRToken = this.cardService.generateQRToken(\n      input.guestRestaurantId,\n      input.restaurantId,\n    );\n    const newSixDigitCode = this.cardService.generate6DigitCode();\n\n    console.log(`üé´ Card regenerated:`)\n    console.log(`   QR Token: ${newQRToken.substring(0, 20)}...`)\n    console.log(`   6-Digit: ${newSixDigitCode}\n`);\n\n    // TODO: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É\n    // await this.cardRepository.create(...)\n\n    // 9Ô∏è‚É£ –û–ë–ù–û–í–ò–¢–¨ LAST VISIT\n    await this.guestRestaurantRepository.updateLastVisit(\n      input.guestRestaurantId,\n    );\n\n    console.log(`‚è±Ô∏è  Last visit updated\n`);\n    console.log(`üéâ Transaction completed successfully!\n`);\n\n    return {\n      transactionId: transaction.id,\n      basePointsAwarded: pointsCalculation.basePoints,\n      bonusPointsAwarded: pointsCalculation.bonusPoints,\n      totalPointsAwarded: pointsCalculation.totalPoints,\n      oldBalance: guestRestaurant.balancePoints,\n      newBalance,\n      tierUpgraded,\n      newTierName,\n      newQRToken,\n      newSixDigitCode,\n    };\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≥–æ—Å—Ç—è\n   *\n   * @param guestRestaurantId ID –≥–æ—Å—Ç—è –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ\n   * @param limit –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (default: 50)\n   * @param offset Offset –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (default: 0)\n   * @returns –ú–∞—Å—Å–∏–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π\n   */\n  async getTransactionHistory(\n    guestRestaurantId: string,\n    limit: number = 50,\n    offset: number = 0,\n  ): Promise<TransactionHistoryItem[]> {\n    const transactions = await this.transactionRepository.getByGuest(\n      guestRestaurantId,\n      limit,\n      offset,\n    );\n\n    return transactions.map((txn) => ({\n      transactionId: txn.id,\n      type: txn.type,\n      amount: txn.amount,\n      pointsAwarded: txn.basePointsAwarded + txn.bonusPointsAwarded,\n      newBalance: txn.newBalance,\n      status: txn.status,\n      createdAt: txn.createdAt,\n    }));\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –≥–æ—Å—Ç—è\n   *\n   * @param guestRestaurantId ID –≥–æ—Å—Ç—è –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ\n   * @returns –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –±–∞–ª–ª–æ–≤\n   */\n  async getCurrentBalance(guestRestaurantId: string): Promise<number> {\n    const guestRestaurant = await this.guestRestaurantRepository.getById(\n      guestRestaurantId,\n    );\n\n    if (!guestRestaurant) {\n      throw {\n        code: ErrorCode.GUEST_NOT_FOUND,\n        message: `–ì–æ—Å—Ç—å ${guestRestaurantId} –Ω–µ –Ω–∞–π–¥–µ–Ω`,\n      };\n    }\n\n    return guestRestaurant.balancePoints;\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç –æ–±—â—É—é —Å—É–º–º—É –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω–æ–≥–æ –≥–æ—Å—Ç–µ–º\n   *\n   * @param guestRestaurantId ID –≥–æ—Å—Ç—è –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ\n   * @returns –û–±—â–∞—è —Å—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö\n   */\n  async getTotalSpent(guestRestaurantId: string): Promise<number> {\n    return this.transactionRepository.getTotalSpent(guestRestaurantId);\n  }\n\n  /**\n   * –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–∑–∏—Ç–æ–≤ –≥–æ—Å—Ç—è\n   *\n   * @param guestRestaurantId ID –≥–æ—Å—Ç—è –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ\n   * @returns –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–∑–∏—Ç–æ–≤\n   */\n  async getVisitCount(guestRestaurantId: string): Promise<number> {\n    const guestRestaurant = await this.guestRestaurantRepository.getById(\n      guestRestaurantId,\n    );\n\n    if (!guestRestaurant) {\n      throw {\n        code: ErrorCode.GUEST_NOT_FOUND,\n        message: `–ì–æ—Å—Ç—å ${guestRestaurantId} –Ω–µ –Ω–∞–π–¥–µ–Ω`,\n      };\n    }\n\n    return guestRestaurant.visitsCount;\n  }\n\n  // ===== PRIVATE HELPERS =====\n\n  /**\n   * –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n   */\n  private validateInput(input: ProcessSaleTransactionInput): void {\n    if (!input.guestRestaurantId) {\n      throw {\n        code: ErrorCode.VALIDATION_ERROR,\n        message: 'guestRestaurantId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω',\n      };\n    }\n\n    if (!input.restaurantId) {\n      throw {\n        code: ErrorCode.VALIDATION_ERROR,\n        message: 'restaurantId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω',\n      };\n    }\n\n    if (!input.amountRubles || input.amountRubles <= 0) {\n      throw {\n        code: ErrorCode.VALIDATION_ERROR,\n        message: 'amountRubles –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 0',\n      };\n    }\n\n    if (input.amountRubles > 1000000) {\n      throw {\n        code: ErrorCode.VALIDATION_ERROR,\n        message: 'amountRubles –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç (1,000,000)',\n      };\n    }\n  }\n\n  /**\n   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏\n   * –§–æ—Ä–º–∞—Ç: txn-{timestamp}-{random}\n   */\n  private generateTransactionId(): string {\n    return `txn-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n  }\n}\n\nexport {\n  ProcessSaleTransactionInput,\n  ProcessSaleTransactionOutput,\n  TransactionHistoryItem,\n};\n